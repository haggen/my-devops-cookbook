#!/usr/bin/env bash

set -ue

# Go to where's the application
cd $HOME/app

# Avoid merge conflicts
git -C $HOME/app reset --hard

# Update codebase
git -C $HOME/app pull $HOME/git master

# Install dependencies in vendor/bundle
bundle install --deployment --without=development:doc

# Run pending migrations
foreman run bundle exec rake db:migrate

# Pre-compile static assets
foreman run bundle exec rake assets:precompile

# (Re)Export upstart process
foreman export upstart -l $HOME/log

# (Re)Start application processes
stop app
start app